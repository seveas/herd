version: '3.5'
services:
  nginx:
    image: nginx:latest
    networks:
      default:
        aliases:
          - inventory.example.com
    volumes:
      - source: ./integration/nginx/etc/nginx/conf.d
        target: /etc/nginx/conf.d
        type: bind
      - source: ./integration/pki
        target: /etc/ssl
        type: bind
      - source: ./integration/nginx/www
        target: /www
        type: bind
  openssh:
    build:
      context: integration/openssh
    networks:
      default:
        aliases:
          - ssh.example.com
  openssh-rsa:
    image: katyusha_openssh
    networks:
      default:
        aliases:
          - ssh-rsa.example.com
    command: -o HostKey=/etc/ssh/ssh_host_rsa_key
  openssh-ecdsa:
    image: katyusha_openssh
    networks:
      default:
        aliases:
          - ssh-ecdsa.example.com
    command: -o HostKey=/etc/ssh/ssh_host_ecdsa_key
  openssh-ed25519:
    image: katyusha_openssh
    networks:
      default:
        aliases:
          - ssh-ed25519.example.com
    command: -o HostKey=/etc/ssh/ssh_host_ed25519_key
  katyusha:
    build:
      context: "."
      dockerfile: Dockerfile
    command: make -C integration test
    depends_on:
      - nginx
